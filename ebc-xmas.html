<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>What's The MRT?</title>
  <style>
    @font-face {
      font-family: "MyFont";
      src: url("./fonts/MyFont.woff2") format("woff2"),
           url("./fonts/MyFont.woff") format("woff"),
           url("./fonts/MyFont.ttf") format("truetype");
      font-display: swap;
    }

    :root {
      --bg: #f8fafb;
      --card: #ffffff;
      --border: #e8edf2;
      --text: #1f2a3d;
      --muted: #6b778c;
      --accent: #22c55e;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.07);
      --radius: 18px;
      --badge: #eef2f7;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 28px; font-family: "MyFont"; background: var(--bg); color: var(--text); }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 24px; font-weight: 700; }
    header .pill { background: var(--badge); color: var(--muted); padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: 600; }

    /* Center-aligned login (neutral styling) */
    .login-hero {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - 160px); /* fill most of viewport minus header padding */
      margin: 0 0 32px;
    }
    .login-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 520px;
      padding: 28px 24px;
      text-align: center;
    }
    .login-card h2 { margin: 0 0 8px; }
    .login-card p { margin: 0 0 16px; color: var(--muted); }
    .login-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: center; }
    .login-group input {
      min-width: 240px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-weight: 600;
    }
    .login-btn {
      background: var(--text);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 10px 18px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: opacity 0.2s, transform 0.2s;
    }
    .login-btn:hover { opacity: 0.9; }
    .login-btn:active { transform: translateY(1px); }
    #loginError { color: #d92d20; font-weight: 600; margin-top: 8px; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    select, button, input { border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; font-weight: 600; background: #fff; color: var(--text); touch-action: manipulation; }
    select { min-width: 220px; background-image: linear-gradient(45deg, transparent 50%, #6b778c 50%), linear-gradient(135deg, #6b778c 50%, transparent 50%); background-position: right 12px center, right 6px center; background-size: 8px 8px, 8px 8px; background-repeat: no-repeat; -webkit-appearance: none; appearance: none; padding-right: 30px; }
    button { background: var(--text); color: #fff; border: none; box-shadow: var(--shadow); cursor: pointer; transition: opacity 0.2s, transform 0.2s; }
    button:hover { opacity: 0.9; }
    button:active { transform: translateY(1px); }
    .board { display: none; flex-direction: column; gap: 12px; }
    .board.active { display: flex; }
    .board-title { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .line-badge { padding: 8px 12px; border-radius: 12px; font-weight: 800; font-size: 13px; background: #fff; border: 1px solid var(--border); color: var(--muted); }
    .slots-wrap { background: #fbfcfe; border: 1px dashed var(--border); border-radius: 16px; padding: 18px; position: relative; overflow-x: auto; }
    .slots { display: flex; gap: 16px; align-items: center; position: relative; min-height: 76px; padding: 8px 4px; width: max-content; }
    .slots::after { content: ""; position: absolute; left: 0; right: 0; top: 50%; height: 1.5px; background: #e0e7ff; z-index: 0; }
    .slot { position: relative; z-index: 1; border: 1px solid #e0e7ff; border-radius: 12px; background: #fff; min-width: 110px; min-height: 52px; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 1px 0 rgba(255,255,255,0.7); transition: border-color 0.2s, background 0.2s; flex-shrink: 0; }
    .slot.drag-over { border-color: var(--accent); background: #eefbf3; }
    .slot.locked { opacity: 0.9; }
    .chip { padding: 10px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; border: 1px solid #e0e7ff; cursor: grab; user-select: none; box-shadow: 0 6px 16px rgba(67, 56, 202, 0.1); transition: transform 0.12s ease; white-space: nowrap; touch-action: none; border: 1px solid transparent; background: #eef2ff; color: #4338ca; }
    .chip:active { cursor: grabbing; transform: scale(0.98); }
    .chip.locked { cursor: not-allowed; opacity: 0.7; }
    .chip.flying { position: fixed; pointer-events: none; z-index: 2000; transform: translate(-50%, -50%); box-shadow: 0 10px 26px rgba(15, 23, 42, 0.18); opacity: 0.96; }
    .pool-label { color: #000000; font-weight: 700; margin: 0 0 8px; font-size: 13px; }
    .pool { display: flex; flex-wrap: wrap; gap: 10px; }
    .empty { color: var(--muted); font-weight: 600; font-size: 14px; padding: 12px 0; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 999; padding: 20px; }
    .modal-backdrop.active { display: flex; }
    .modal { background: #fff; border-radius: 16px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.2); padding: 20px; max-width: 360px; width: 100%; border: 1px solid var(--border); }
    .modal h3 { margin: 0 0 8px; }
    .modal p { margin: 6px 0; color: var(--muted); }
    .modal .metric-row { display: flex; justify-content: space-between; margin: 6px 0; font-weight: 700; }
    .close-btn { margin-top: 12px; width: 100%; background: var(--text); color: #fff; border: none; border-radius: 12px; padding: 10px; font-weight: 700; cursor: pointer; }

    @media (max-width: 768px) {
      .controls { flex-direction: column; align-items: flex-start; }
      select { width: 100%; max-width: 480px; }
      .login-group { flex-direction: column; align-items: center; }
      .login-group input { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>What's The MRT?</h1>
    <div class="pill">EBC Christmas Game</div>
  </header>

  <!-- Centered Login -->
  <div class="login-hero" id="loginHero">
    <div class="login-card" id="loginCard">
      <h2>Login to Play</h2>
      <p>Enter your name to start</p>
      <div class="login-group">
        <input type="text" id="playerName" placeholder="Enter your name..." />
        <button id="loginBtn" class="login-btn">Login</button>
      </div>
      <p id="loginError"></p>
    </div>
  </div>

  <!-- Game card -->
  <div class="card" id="gameCard" style="display:none;">
    <div class="controls">
      <label for="lineSelect" style="font-weight:700;">MRT Line:</label>
      <select id="lineSelect" aria-label="Select MRT line" disabled>
        <option value="" selected disabled>Choose a line…</option>
        <option value="ns">North South Line (NS)</option>
        <option value="ew">East West Line (EW)</option>
        <option value="ne">North East Line (NE)</option>
        <option value="dt">Downtown Line (DT)</option>
        <option value="te">Thomson–East Coast Line (TE)</option>
      </select>
      <button id="submitBtn">Submit</button>
    </div>

    <div class="empty" id="emptyState">Select a line to load the quiz.</div>

    <div class="board" id="board">
      <div class="board-title">
        <div>
          <div id="lineTitle" style="font-size:18px; font-weight:800;"></div>
          <div style="color:#000000; font-size:13px; font-weight:700; margin-top:4px;">
            Drag stations into the slots.
          </div>
        </div>
        <span class="line-badge" id="lineBadge"></span>
      </div>

      <div class="slots-wrap">
        <div class="slots" id="slots"></div>
      </div>

      <div class="pool-label">Every station of the selected line:</div>
      <div class="pool" id="pool"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3>Your result</h3>
      <div class="metric-row"><span>Score</span><span id="modalScore"></span></div>
      <div class="metric-row"><span>Placed</span><span id="modalPlaced"></span></div>
      <p id="modalLine"></p>
      <button class="close-btn" id="closeModal">Close</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzVPq1coPCGjcFcrbetpmNi4uRx-O2W-bYOTI-I6Fg7WEut8pvO270zMDJufanodH93/exec";

    const lines = {
      ns: { code: "NS", name: "North South Line", color: "#D8242A", stations: [
        "Jurong East","Bukit Batok","Bukit Gombak","Choa Chu Kang","Yew Tee","Kranji","Marsiling","Woodlands",
        "Admiralty","Sembawang","Canberra","Yishun","Khatib","Yio Chu Kang","Ang Mo Kio","Bishan","Braddell",
        "Toa Payoh","Novena","Newton","Orchard","Somerset","Dhoby Ghaut","City Hall","Raffles Place","Marina Bay",
        "Marina South Pier"
      ]},
      ew: { code: "EW", name: "East West Line", color: "#009739", stations: [
        "Pasir Ris","Tampines","Simei","Tanah Merah","Bedok","Kembangan","Eunos","Paya Lebar","Aljunied","Kallang",
        "Lavender","Bugis","City Hall","Raffles Place","Tanjong Pagar","Outram Park","Tiong Bahru","Redhill",
        "Queenstown","Commonwealth","Buona Vista","Dover","Clementi","Jurong East","Chinese Garden","Lakeside","Boon Lay",
        "Pioneer","Joo Koon","Gul Circle","Tuas Crescent","Tuas West Road","Tuas Link"
      ]},
      ne: { code: "NE", name: "North East Line", color: "#9B27B0", stations: [
        "HarbourFront","Outram Park","Chinatown","Clarke Quay","Dhoby Ghaut","Little India","Farrer Park","Boon Keng",
        "Potong Pasir","Woodleigh","Serangoon","Kovan","Hougang","Buangkok","Sengkang","Punggol","Punggol Coast"
      ]},
      dt: { code: "DT", name: "Downtown Line", color: "#005EB8", stations: [
        "Bukit Panjang","Cashew","Hillview","Hume","Beauty World","King Albert Park","Sixth Avenue","Tan Kah Kee",
        "Botanic Gardens","Stevens","Newton","Little India","Rochor","Bugis","Promenade","Bayfront","Downtown",
        "Telok Ayer","Chinatown","Fort Canning","Bencoolen","Jalan Besar","Bendemeer","Geylang Bahru","Mattar",
        "MacPherson","Ubi","Kaki Bukit","Bedok North","Bedok Reservoir","Tampines West","Tampines","Tampines East",
        "Upper Changi","Expo"
      ]},
      te: { code: "TE", name: "Thomson–East Coast Line", color: "#8B5E3C", stations: [
        "Woodlands North","Woodlands","Woodlands South","Springleaf","Lentor","Mayflower","Bright Hill","Upper Thomson",
        "Caldecott","Stevens","Napier","Orchard Boulevard","Orchard","Great World","Havelock","Outram Park","Maxwell",
        "Shenton Way","Marina Bay","Gardens by the Bay","Tanjong Rhu","Katong Park","Tanjong Katong",
        "Marine Parade","Marine Terrace","Siglap","Bayshore"
      ]}
    };

    const hintCounts = { ns: 12, ew: 18, ne: 2, dt: 20, te: 12 };

    const loginHero = document.getElementById("loginHero");
    const loginBtn = document.getElementById("loginBtn");
    const loginError = document.getElementById("loginError");
    const playerNameInput = document.getElementById("playerName");

    const gameCard = document.getElementById("gameCard");
    const lineSelect = document.getElementById("lineSelect");
    const board = document.getElementById("board");
    const emptyState = document.getElementById("emptyState");
    const lineTitle = document.getElementById("lineTitle");
    const lineBadge = document.getElementById("lineBadge");
    const slotsEl = document.getElementById("slots");
    const poolEl = document.getElementById("pool");
    const submitBtn = document.getElementById("submitBtn");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalScore = document.getElementById("modalScore");
    const modalPlaced = document.getElementById("modalPlaced");
    const modalLine = document.getElementById("modalLine");
    const closeModal = document.getElementById("closeModal");

    let chips = [];
    let locked = false;
    let flyChip = null;
    let currentUser = "";

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function pickHintIndices(len, count) {
      const result = [];
      if (count <= 0) return result;
      const maxCount = Math.min(count, len);
      let attempts = 0;
      while (result.length < maxCount && attempts < 200) {
        const idx = Math.floor(Math.random() * len);
        const tooClose = result.some(i => Math.abs(i - idx) <= 1);
        if (!tooClose && !result.includes(idx)) {
          result.push(idx);
        }
        attempts++;
      }
      return result.sort((a, b) => a - b);
    }

    function tint(hex, alphaBg = 0.16) {
      // simple overlay on white for background tint
      const c = hex.replace('#','');
      const r = parseInt(c.substring(0,2),16);
      const g = parseInt(c.substring(2,4),16);
      const b = parseInt(c.substring(4,6),16);
      const bg = alphaBg;
      return `rgba(${r}, ${g}, ${b}, ${bg})`;
    }

    function applyChipColor(chip, hex) {
      chip.style.background = tint(hex, 0.15);
      chip.style.borderColor = hex;
      chip.style.color = hex;
      chip.style.boxShadow = `0 6px 16px ${tint(hex, 0.20)}`;
    }

    function clearBoard() {
      locked = false;
      removeFlyChip();
      board.classList.remove("active");
      emptyState.style.display = "block";
      slotsEl.innerHTML = "";
      poolEl.innerHTML = "";
    }

    function buildBoard(lineKey) {
      const line = lines[lineKey];
      if (!line) { clearBoard(); return; }

      locked = false;
      removeFlyChip();
      emptyState.style.display = "none";
      board.classList.add("active");

      lineTitle.textContent = line.name;
      lineBadge.textContent = line.color.toUpperCase();
      lineBadge.style.borderColor = line.color + "33";
      lineBadge.style.color = line.color;

      slotsEl.innerHTML = "";
      poolEl.innerHTML = "";
      chips = [];

      const hintCount = hintCounts[lineKey] || 0;
      const hintIndices = pickHintIndices(line.stations.length, hintCount);
      const hintedSet = new Set(hintIndices);

      line.stations.forEach((station, idx) => {
        const slot = document.createElement("div");
        slot.className = "slot";
        slot.dataset.slotIndex = idx;
        addDropHandlers(slot);
        if (hintedSet.has(idx)) {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.draggable = true;
          chip.textContent = station;
          addDragHandlers(chip);
          addTouchHandlers(chip);
          applyChipColor(chip, line.color);
          slot.appendChild(chip);
          chips.push(chip);
        }
        slotsEl.appendChild(slot);
      });

      const remaining = line.stations.filter((_, idx) => !hintedSet.has(idx));
      shuffle(remaining).forEach(st => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.draggable = true;
        chip.textContent = st;
        addDragHandlers(chip);
        addTouchHandlers(chip);
        applyChipColor(chip, line.color);
        poolEl.appendChild(chip);
        chips.push(chip);
      });
    }

    function addDragHandlers(el) {
      el.addEventListener("dragstart", e => {
        if (locked) { e.preventDefault(); return; }
        e.dataTransfer.setData("text/plain", e.target.textContent);
        e.dataTransfer.effectAllowed = "move";
        el.classList.add("dragging");
      });
      el.addEventListener("dragend", () => el.classList.remove("dragging"));
    }

    function addTouchHandlers(el) {
      let currentTouchId = null;
      el.addEventListener("touchstart", e => {
        if (locked) return;
        currentTouchId = e.changedTouches[0].identifier;
        el.classList.add("dragging");
        createFlyChip(el, e.changedTouches[0]);
      }, { passive: true });

      el.addEventListener("touchmove", e => {
        const t = [...e.changedTouches].find(t => t.identifier === currentTouchId);
        if (!t) return;
        e.preventDefault();
        updateFlyChipPosition(t);
      }, { passive: false });

      el.addEventListener("touchend", e => {
        const t = [...e.changedTouches].find(t => t.identifier === currentTouchId);
        if (!t) return;
        const target = document.elementFromPoint(t.clientX, t.clientY);
        handleTouchDrop(el, target);
        el.classList.remove("dragging");
        removeFlyChip();
        currentTouchId = null;
      });
      el.addEventListener("touchcancel", () => {
        el.classList.remove("dragging");
        removeFlyChip();
        currentTouchId = null;
      });
    }

    function createFlyChip(el, touch) {
      removeFlyChip();
      flyChip = el.cloneNode(true);
      flyChip.classList.add("flying");
      flyChip.style.width = el.offsetWidth + "px";
      flyChip.style.height = el.offsetHeight + "px";
      document.body.appendChild(flyChip);
      updateFlyChipPosition(touch);
    }
    function updateFlyChipPosition(touch) {
      if (!flyChip) return;
      flyChip.style.left = touch.clientX + "px";
      flyChip.style.top = touch.clientY + "px";
    }
    function removeFlyChip() {
      if (flyChip && flyChip.parentElement) flyChip.parentElement.removeChild(flyChip);
      flyChip = null;
    }

    function handleTouchDrop(chip, target) {
      if (!target) return;
      const slot = target.closest(".slot");
      if (slot && !locked) {
        const existingChip = slot.querySelector(".chip");
        if (existingChip) poolEl.appendChild(existingChip);
        slot.appendChild(chip);
        return updateProgress();
      }
      poolEl.appendChild(chip);
      updateProgress();
    }

    function addDropHandlers(zone) {
      zone.addEventListener("dragover", e => {
        if (locked) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        zone.classList.add("drag-over");
      });
      zone.addEventListener("dragleave", () => zone.classList.remove("drag-over"));
      zone.addEventListener("drop", e => {
        if (locked) return;
        e.preventDefault();
        const dragging = document.querySelector(".chip.dragging");
        if (!dragging) return;
        zone.classList.remove("drag-over");

        const existingChip = zone.querySelector(".chip");
        if (existingChip) poolEl.appendChild(existingChip);

        zone.appendChild(dragging);
        updateProgress();
      });
    }

    poolEl.addEventListener("dragover", e => { if (locked) return; e.preventDefault(); e.dataTransfer.dropEffect = "move"; });
    poolEl.addEventListener("drop", e => {
      if (locked) return;
      e.preventDefault();
      const dragging = document.querySelector(".chip.dragging");
      if (!dragging) return;
      poolEl.appendChild(dragging);
      updateProgress();
    });

    function updateProgress() {
      // progress hidden in UI; kept for extensibility
    }

    async function grade() {
      const lineKey = lineSelect.value;
      const line = lines[lineKey];
      if (!line) return;

      const total = chips.length;
      let correct = 0;

      const placements = Array.from(document.querySelectorAll(".slot")).map(slot => {
        const chip = slot.querySelector(".chip");
        return chip ? chip.textContent : "";
      });

      placements.forEach((name, idx) => {
        if (name && name === line.stations[idx]) correct += 1;
      });

      const placed = placements.filter(Boolean).length;

      showModal(correct, placed, total, line.name);

      lockBoard();

      const scoreValue = `${correct} / ${total}`;
      
      try {
        const formData = new FormData();
        formData.append("action", "submit");
        formData.append("user", currentUser);
        formData.append("score", scoreValue);
        await fetch(API_URL, { method: "POST", body: formData });
      } catch (err) {
        console.warn("Submit upload failed:", err);
}
    }

    function lockBoard() {
      locked = true;
      lineSelect.disabled = true;
      submitBtn.disabled = true;
      document.querySelectorAll(".chip").forEach(chip => {
        chip.classList.add("locked");
        chip.draggable = false;
      });
      document.querySelectorAll(".slot").forEach(slot => slot.classList.add("locked"));
    }

    function unlockBoard() {
      locked = false;
      lineSelect.disabled = false;
      submitBtn.disabled = false;
      document.querySelectorAll(".chip").forEach(chip => {
        chip.classList.remove("locked");
        chip.draggable = true;
      });
      document.querySelectorAll(".slot").forEach(slot => slot.classList.remove("locked"));
    }

    function showModal(correct, placed, total, lineName) {
      modalScore.textContent = `${correct} / ${total}`;
      modalPlaced.textContent = `${placed} placed`;
      modalLine.textContent = lineName;
      modalBackdrop.classList.add("active");
    }
    function hideModal() {
      modalBackdrop.classList.remove("active");
    }

    loginBtn.addEventListener("click", () => {
      const name = playerNameInput.value.trim();
      if (!name) {
        loginError.textContent = "Name cannot be empty.";
        return;
      }
      currentUser = name;
      loginError.textContent = "";
      loginHero.style.display = "none";
      gameCard.style.display = "block";
      lineSelect.disabled = false;
      lineSelect.focus();
    });

    const handleLineSelect = () => { buildBoard(lineSelect.value); unlockBoard(); };
    lineSelect.addEventListener("change", handleLineSelect);
    lineSelect.addEventListener("input", handleLineSelect);

    submitBtn.addEventListener("click", grade);
    closeModal.addEventListener("click", hideModal);
    modalBackdrop.addEventListener("click", e => { if (e.target === modalBackdrop) hideModal(); });

    clearBoard();
  </script>
</body>
</html>
